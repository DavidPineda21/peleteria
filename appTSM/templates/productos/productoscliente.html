{% extends 'base.html' %}
{% block titulo %}Productos{% endblock %}
{% load static %}
{% block tituloNav %}Productos{% endblock %}
{% block contenido %}


    <ul class="list-group list-group-flush">
        <li class="list-group-item">
            <a class="btn btn-primary btn-sm" title="Inicio" href="{% url 'inicio' %}" role="button">
                <i class="bi bi-house-door-fill"></i>&nbsp;Inicio
            </a>
            {% if perms.appTSM.add_clsproductos %}
                <a name="" id="" class="btn btn-success btn-sm" title="Agregar" href="{% url 'crearProducto' %}" role="button">
                    <i class="bi bi-file-earmark-plus-fill"></i>&nbsp;Agregar Inventario
                </a>
            {% endif %}
            {% if perms.appTSM.view_clsproductos %}
            <a href="{% url 'inicio' %}" class="btn btn-success btn-sm" title="Exportar">Exportar a CSV</a>
            {% endif %}
            <button class="btn btn-danger btn-sm" id="btn-limpiar" title="Reiniciar filtro">Reiniciar filtro</button>
            <span class="float-end">
                Resultados: <strong id="total-resultados"></strong>
            </span>
        </li>
    </ul>



        <div class="w-100 p-0 m-0">
            <div class="w-100 p-0 m-0">

                <div class="card shadow-sm border-0">
                    <div class="card-body">
            
                        <div class="row g-3 align-items-center">
            
                            <!-- Tipo Producto -->
                            <div class="col-12 col-md-4">
                                <label class="form-label fw-semibold">Tipo de Producto</label>
                                <div class="dropdown w-100" data-bs-display="static">
                                    <button class="btn btn-outline-dark dropdown-toggle w-100 text-start"
                                            type="button"
                                            id="filtro-tipoproducto"
                                            data-bs-toggle="dropdown">
                                        Selecciona tipo Producto
                                    </button>
                                    <ul class="dropdown-menu w-100" style="max-height:200px; overflow-y:auto;">
                                        {% for tipoproducto in tipoproductos %}
                                        <li>
                                            <label class="dropdown-item">
                                                <input type="checkbox"
                                                       class="form-check-input me-2 filtro-tipoproducto"
                                                       value="{{ tipoproducto }}">
                                                {{ tipoproducto }}
                                            </label>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
            
                            <!-- Color -->
                            <div class="col-12 col-md-4">
                                <label class="form-label fw-semibold">Color</label>
                                <div class="dropdown w-100" data-bs-display="static">
                                    <button class="btn btn-outline-dark dropdown-toggle w-100 text-start"
                                            type="button"
                                            id="filtro-color"
                                            data-bs-toggle="dropdown">
                                        Selecciona color
                                    </button>
                                    <ul class="dropdown-menu w-100" style="max-height:200px; overflow-y:auto;">
                                        {% for color in colores %}
                                        <li>
                                            <label class="dropdown-item">
                                                <input type="checkbox"
                                                       class="form-check-input me-2 filtro-color"
                                                       value="{{ color }}">
                                                {{ color }}
                                            </label>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
            
                            <!-- Precio por Metro -->
                            <div class="col-12 col-md-4">
                                <label class="form-label fw-semibold">Precio por Metro</label>
                                <div class="dropdown w-100" data-bs-display="static">
                                    <button class="btn btn-outline-dark dropdown-toggle w-100 text-start"
                                            type="button"
                                            id="filtro-precioxm"
                                            data-bs-toggle="dropdown">
                                        Selecciona precio por metro
                                    </button>
                                    <ul class="dropdown-menu w-100" style="max-height:200px; overflow-y:auto;">
                                        {% for precioxm in precioxms %}
                                        <li>
                                            <label class="dropdown-item">
                                                <input type="checkbox"
                                                       class="form-check-input me-2 filtro-precioxm"
                                                       value="{{ precioxm }}">
                                                {{ precioxm }}
                                            </label>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
            
            
                        </div>
            
                    </div>
                </div>
            <div id="productos-grid" class="row g-4 mx-0 mb-4 mt-2">
                <!-- Aqu√≠ se cargan las cards -->
            </div>
        </div>
        </div>
        <div id="paginador"></div>

    <script>
        
        const puedeEditar = {{ perms.appTSM.change_clsproductos|yesno:"true,false" }};
        const puedeEliminar = {{ perms.appTSM.delete_clsproductos|yesno:"true,false" }};
        let pagina = 1;
        const grid = document.getElementById("productos-grid");
        const paginadorDiv = document.getElementById("paginador");

        function cargarProducto(p = pagina) {
            
            // Filtros por columna
            const filtros = {
                tipoproducto: Array.from(document.querySelectorAll('.filtro-tipoproducto:checked')).map(cb => cb.value),
                color: Array.from(document.querySelectorAll('.filtro-color:checked')).map(cb => cb.value),
                precioxm: Array.from(document.querySelectorAll('.filtro-precioxm:checked')).map(cb => cb.value),
            };

            // Construye la query string
            let params = `?page=${p}`;
            for (const key in filtros) {
                if (Array.isArray(filtros[key]) && filtros[key].length > 0) {
                    filtros[key].forEach(val => {
                        params += `&${key}=${encodeURIComponent(val)}`;
                    });
                } else if (filtros[key]) {
                    params += `&${key}=${encodeURIComponent(filtros[key])}`;
                }
            }
            // Realiza la petici√≥n al servidor
            fetch(`/productos/api/${params}`)
                .then(res => res.json())
                .then(data => {
                    grid.innerHTML = "";
                    document.getElementById("total-resultados").textContent = data.total;
                    data.datos.forEach(productos => {

                        let botones = '';
                        if (puedeEditar) {
                            botones += `
                                <a class="btn btn-sm btn-light me-1" 
                                href="/productos/editar/${productos.idproducto}">
                                ‚úèÔ∏è
                                </a>
                            `;
                        }
                        if (puedeEliminar) {
                            botones += `
                                <button class="btn btn-sm btn-light">
                                    üóëÔ∏è
                                </button>
                            `;
                        }

                        // Slider im√°genes
                        let imagenes = '';
                        if (productos.fotos.length > 0) {
                            productos.fotos.forEach((foto, index) => {
                                imagenes += `
                                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                        <img src="${foto}" class="d-block w-100 img-card-producto">
                                    </div>
                                `;
                            });
                        } else {
                            imagenes = `
                                <div class="carousel-item active">
                                    <img src="{% static 'img/no-image.png' %}" class="d-block w-100 img-card-producto">
                                </div>
                            `;
                        }

                        const card = document.createElement("div");
                        card.className = "col-12 col-sm-6 col-md-4 col-lg-3";

                        card.innerHTML = `
                            <div class="card h-100 shadow-sm border-0 producto-card">
                                
                                <div id="carousel${productos.idproducto}" 
                                    class="carousel slide">
                                    <div class="carousel-inner">
                                        ${imagenes}
                                    </div>
                                    ${productos.fotos.length > 1 ? `
                                    <button class="carousel-control-prev" type="button" 
                                            data-bs-target="#carousel${productos.idproducto}" 
                                            data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon"></span>
                                    </button>
                                    <button class="carousel-control-next" type="button" 
                                            data-bs-target="#carousel${productos.idproducto}" 
                                            data-bs-slide="next">
                                        <span class="carousel-control-next-icon"></span>
                                    </button>
                                    ` : ''}
                                </div>

                                <div class="card-body">
                                    <h6 class="fw-bold">${productos.nombre}</h6>
                                    <small class="text-muted">${productos.tipoproducto}</small>
                                    <p class="mb-1 mt-2">
                                        <strong>$${productos.precio}</strong>
                                    </p>
                                    <small>Stock: ${productos.stock}</small>
                                </div>

                                <div class="card-footer bg-white border-0 text-end">
                                    ${botones}
                                </div>
                            </div>
                        `;

                        grid.appendChild(card);
                    });

                    // üî• Inicializar carouseles despu√©s de renderizar
document.querySelectorAll('#productos-grid .carousel').forEach(carouselEl => {
    new bootstrap.Carousel(carouselEl, {
        interval: 6000,
        ride: 'carousel',
        pause: false,
        wrap: true
    });
});
                    // Paginador
                    paginadorDiv.innerHTML = `
                            <div aria-label="Page navigation">
                                <ul class="pagination justify-content-center flex-wrap">
                                    <li class="page-item ${data.current_page === 1 ? 'disabled' : ''}">
                                        <a class="page-link" href="#" aria-label="Primera">
                                            <span aria-hidden="true">&laquo; Primera</span>
                                        </a>
                                    </li>
                                    <li class="page-item ${data.current_page === 1 ? 'disabled' : ''}">
                                        <a class="page-link" href="#" aria-label="Anterior">
                                            <span aria-hidden="true">Anterior</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <span class="page-link">P√°gina ${data.current_page} de ${data.num_pages}</span>
                                    </li>
                                    <li class="page-item ${data.current_page === data.num_pages ? 'disabled' : ''}">
                                        <a class="page-link" href="#" aria-label="Siguiente">
                                            <span aria-hidden="true">Siguiente</span>
                                        </a>
                                    </li>
                                    <li class="page-item ${data.current_page === data.num_pages ? 'disabled' : ''}">
                                        <a class="page-link" href="#" aria-label="√öltima">
                                            <span aria-hidden="true">√öltima &raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                    `;

                // Agregar despu√©s del template string del paginador
                const btnPrimera = paginadorDiv.querySelector('[aria-label="Primera"]');
                const btnAnterior = paginadorDiv.querySelector('[aria-label="Anterior"]');
                const btnSiguiente = paginadorDiv.querySelector('[aria-label="Siguiente"]');
                const btnUltima = paginadorDiv.querySelector('[aria-label="√öltima"]');

                if (data.current_page > 1) {
                    btnPrimera.addEventListener('click', () => cargarProducto(1));
                    btnAnterior.addEventListener('click', () => cargarProducto(data.current_page - 1));
                }

                if (data.current_page < data.num_pages) {
                    btnSiguiente.addEventListener('click', () => cargarProducto(data.current_page + 1));
                    btnUltima.addEventListener('click', () => cargarProducto(data.num_pages));
                }
                })
                .catch(err => {
                    console.error("Error cargando datos:", err);
                });
        }

        function debounce(fn, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(this, args), delay);
        };
        }

        // Limpiar b√∫squeda general y filtros
        document.getElementById("btn-limpiar").addEventListener("click", () => {
            // Limpiar inputs de texto
            ["filtro-tipoproducto","filtro-color","filtro-precioxm"].forEach(id => {
                document.getElementById(id).value = "";
            });
            // Limpiar checkboxes
            document.querySelectorAll('.filtro-tipoproducto, .filtro-color, .filtro-precioxm').forEach(cb => cb.checked = false);
            pagina = 1;
            cargarProducto(1);
        });

        // Filtros solo para inputs de texto
        ["filtro-tipoproducto","filtro-color","filtro-precioxm"].forEach(id => {
            document.getElementById(id).addEventListener("input", debounce(() => {
                pagina = 1;
                cargarProducto(1);
            }, 1000));
        });

        // Escuchar cambios en los checkboxes
        document.querySelectorAll('.filtro-tipoproducto, .filtro-color, .filtro-precioxm').forEach(cb => {
            cb.addEventListener('change', () => {
                pagina = 1;
                cargarProducto(1);
            });
        });

        // Cargar la primera p√°gina al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            cargarProducto(1);
        });
    </script>        

{% endblock %}